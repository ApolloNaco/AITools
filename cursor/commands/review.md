# 智能代码审查规则
##  /review 命令使用方法

### 基本语法
```bash
/review                           # 审查当前工作区变更
/review [commit-hash]             # 审查指定提交
/review --range [hash1]..[hash2]  # 审查提交范围
/review --file [filepath]         # 审查指定文件
/review [options] --output  # 输出审查报告到指定文件
/review --b [branch] # 审查指定分支与master分支的差异
```
### 输出选项
- `--output ` 或 `-o `: 将审查报告保存到默认路径
- 支持的文件格式: `.md` (Markdown格式)
- 保存目录：Ai/review-reports
- 文件名格式: `review-[commit-hash/timestamp].md`

##  审查执行逻辑

### 0. Git命令执行规范

**Cursor环境Git命令解决方案**：

**✅ 智能执行机制**
- 通过`run_terminal_cmd`工具执行git命令
- 工具具备自动中断功能，检测到卡住时自动处理
- 命令格式：`git --no-pager [command]`
- 支持从部分输出中提取完整信息

**🔄 自动处理流程**：
1. **正常执行**：命令快速完成，直接返回结果
2. **检测卡住**：输出完成但进程未结束时，工具自动中断
3. **信息提取**：从已获取的输出中提取所需信息
4. **继续处理**：基于有效信息继续后续分析

**⚠️ 用户手动执行指引**：
如果用户必须手动执行git命令：
1. 使用标准格式：`git --no-pager [command]`
2. 看到完整输出后立即按 `Ctrl+C`
3. 不要等待命令"自然结束"
4. 后续优先使用AI工具代理执行
5. 可以使用mcp工具中的git工具

**🎯 最佳实践**：
1. **AI智能代理**：优先让AI执行所有git命令
2. **自动中断机制**：工具层面解决卡住问题
3. **信息完整性**：确保从输出中获取完整的代码审查信息

**基线选择规则**：
/review --b [branch] # 审查指定分支与master分支的差异
- 分支对比默认以远程 `origin/master` 作为基线。
- 审查前会执行 `git fetch --all --prune` 同步远程引用。
- 如本地 `master` 与远程不一致，以远程为准；无需重置本地分支。
- 若需对比其他远程分支或特定提交，请使用等效 git 命令辅助对比（例如：`git --no-pager diff origin/release/1.2...your-branch`）。

### 1. 输出文件处理
**输出文件生成逻辑**:
- 检测命令中是否包含 `--output` 或 `-o` 参数
- 生成审查报告并保存到指定文件
- 在控制台显示文件保存路径

**自动文件名生成规则**:
- 审查提交: `review-[commit-hash-前8位]-[YYYYMMDD-HHMMSS].md`
- 审查工作区: `review-workspace-[YYYYMMDD-HHMMSS].md`
- 审查文件: `review-file-[文件名]-[YYYYMMDD-HHMMSS].md`
- 审查范围: `review-range-[起始hash前4位]-[结束hash前4位]-[YYYYMMDD-HHMMSS].md`
- 审查分支: `review-branch-[分支名]-[YYYYMMDD-HHMMSS].md`

### 2. 文件类型过滤
**审查范围限制**: 仅审查以下类型的文件，其他文件类型将被忽略
- **Java文件**: `.java` 扩展名的文件
- **XML文件**: `.xml` 扩展名的文件（布局、资源、配置等）
- **Properties文件**: `.properties`扩展名的文件（配置）

**过滤逻辑**:
- 在分析变更时，自动过滤掉非目标文件类型
- 如果变更中没有目标文件类型，输出提示信息
- 在审查报告中明确标注审查的文件类型和数量

### 3. 变更内容分析
- **代码变更解析**: 逐行分析代码变更，理解修改意图和影响范围
- **文件关联分析**: 分析修改文件之间的依赖关系和影响链
- **业务逻辑理解**: 结合项目上下文理解业务逻辑变更

### 4. 团队规范检查 
- **注释添加**: 1.在代码中使用Map数据结构，是否有写key和value的注释 2.方法代码是否有注释解释
- **代码复用**：1.是否存在可复用的方法没有抽成模块和方法
- **if/else逻辑冗余**: 1.代码中应该尽可能的避免冗余的if/else模块，增加后续人员维护成本
- **链接域名补全缺失**: 对于图片地址、跳转链接等URL字段，未通过统一的方法（如封装的加域名/拼接域名工具方法）进行域名补全，可能导致线上访问失败、资源错误指向或多机房/多环境下资源无法访问，是影响线上功能正确性与稳定性的卡点，必须作为严重问题处理
该模块全部属于🔴 严重问题 (Critical)

按严重程度分级检查以下问题类型：

#### 🔴 严重问题 (Critical)
- **内存泄漏**: Java服务端中线程池、连接池、缓存、定时任务等长生命周期对象或资源未正确释放，导致内存无法回收
- **线程安全**: 并发访问、共享资源竞争、死锁风险
- **安全漏洞**: SQL注入、XSS攻击、敏感信息泄露
- **崩溃风险**: 空指针异常、数组越界、类型转换异常
- **架构违反**: 违反MVVM 架构原则、循环依赖


#### 🟡 中等问题 (Major)
- **性能问题**: 内存占用过高、CPU密集操作、IO阻塞
- **数据一致性**: 状态不同步、缓存失效、事务问题
- **异常处理**: 异常捕获不当、错误传播、资源未释放
- **API使用**: 过时API、不当使用、版本兼容性
- **代码重复**: 重复逻辑、可复用性差

#### 🟢 轻微问题 (Minor)
- **代码规范**: 命名不规范、格式问题、注释缺失
- **可读性**: 逻辑复杂、嵌套过深、方法过长
- **可维护性**: 硬编码、魔法数字、配置分散
- **最佳实践**: 设计模式使用、代码组织

### 5. 项目规范检查
- **编码规范**: 遵循项目Kotlin/Java编码标准
- **架构规范**: 符合项目架构设计原则
- **性能规范**: 满足性能要求和优化建议
- **安全规范**: 符合安全编码规范

##  审查报告格式

### 输出行为说明
- **控制台输出**: 默认在控制台显示审查报告
- **文件输出**: 当使用 `--output` 或 `-o` 参数时，同时保存到文件
- **输出确认**: 文件保存成功后显示保存路径
- **错误处理**: 如果文件保存失败，显示错误信息但继续控制台输出

### 标准审查报告模板
```markdown
#  代码审查报告 - [Commit/Range/File/Branch]

##  基本信息
- **审查对象**: [提交哈希/文件路径/提交范围/审查分支]
- **审查时间**: [当前时间]
- **审查模式**: [标准/详细/快速]
- **文件类型**: 仅审查 Java(.java)、XML(.xml) 文件、Properties(.properties) 文件
- **变更统计**: [+行数, -行数, 审查文件数/总文件数]

##  变更内容分析

### 主要修改内容
[概述主要变更内容和目的]

### 具体变更详情
#### 1. [文件名] (+新增行数, -删除行数)
**修改目的**: [说明修改目的]

**关键变更**:
```
// 变更前代码
- [原代码]

// 变更后代码  
+ [新代码]
```

##  发现的问题

### 🔴 严重问题 ([数量]个)
#### [序号]. [问题标题] - [文件名:行号]
```[语言]
// 问题代码
[有问题的代码片段]
```
**问题分析**: 
[详细分析问题原因和影响]

**修复建议**:
```
// 修复方案
[修复后的代码]
```

### 🟡 中等问题 ([数量]个)
[同上格式]

### 🟢 轻微问题 ([数量]个)
[同上格式]

##  风险评估

### 高风险 🔴
- **[风险类型]**: [风险描述和影响]

### 中风险 🟡  
- **[风险类型]**: [风险描述和影响]

### 低风险 🟢
- **[风险类型]**: [风险描述和影响]

##  修复优先级

### 必须修复 (合入前)
1. 🔴 [严重问题描述]
2. 🔴 [严重问题描述]

### 建议修复 (合入后)
3. 🟡 [中等问题描述]
4. 🟡 [中等问题描述]

### 可选修复
5. 🟢 [轻微问题描述]
6. 🟢 [轻微问题描述]

##  合入建议

**[✅ 建议合入 / ⚠️ 谨慎合入 / ❌ 暂不建议合入]**

**[阻塞原因/注意事项]**:
[详细说明合入建议的原因]

**合入条件** (如果不建议合入):
- [修复条件1]
- [修复条件2]

**预计修复时间**: [时间估算]
```

##  审查配置

### 输出文件配置
**默认输出目录**: `review-reports/`
**支持的输出格式**:
- Markdown (`.md`) - 默认格式，包含完整的格式化内容


### 文件类型过滤规则
**支持的文件扩展名**:
- `.java` - Java源代码文件
- `.kt` - Kotlin源代码文件
- `.kts` - Kotlin脚本文件
- `.xml` - XML配置/布局/资源文件

**过滤行为**:
- 自动跳过不支持的文件类型（如 .md, .txt, .json, .gradle, 等）
- 在审查开始时显示过滤统计信息
- 如果没有找到支持的文件类型，提示用户并终止审查

**过滤示例**:
```
 文件过滤结果:
✅ 审查文件: 5个 (3个.properties, 1个.java, 1个.xml)
⏭️ 跳过文件: 8个 (4个.md, 2个.gradle, 1个.json)
```

##  文件类型检查规范

### Java文件 (.java) 检查重点
- **内存管理**: 对象生命周期、资源释放、内存泄漏
- **异常处理**: try-catch使用、异常传播、资源清理
- **线程安全**: 同步机制、并发集合、volatile使用
- **设计模式**: 单例、工厂、观察者等模式的正确实现
- **代码规范**: 命名规范、注释完整性、方法长度

### Kotlin文件 (.kt/.kts) 检查重点
- **空安全**: null检查、安全调用操作符、Elvis操作符
- **协程使用**: 作用域管理、异常处理、取消机制
- **扩展函数**: 合理性检查、性能影响、命名规范
- **数据类**: equals/hashCode实现、不可变性
- **函数式编程**: 高阶函数使用、lambda表达式优化

### XML文件 (.xml) 检查重点
- **布局性能**: 嵌套层级、ViewStub使用、include/merge标签
- **资源命名**: 命名规范、资源复用、多语言支持
- **依赖关系**: maven的依赖层级关系，存在重复引用和错误引用

### 不支持的文件类型
以下文件类型将被自动跳过，不进行审查：
- 配置文件: `.gradle`, `.json`, `.yaml`, `.yml`
- 文档文件: `.md`, `.txt`, `.rst`
- 资源文件: `.png`, `.jpg`, `.svg`, `.ico`
- 构建文件: `Makefile`, `CMakeLists.txt`
- 其他: `.sh`, `.bat`, `.py`, `.js`, `.css`, `.html`

### 文件过滤执行流程
1. **扫描变更**: 获取所有变更文件列表
2. **类型识别**: 根据文件扩展名识别文件类型
3. **过滤筛选**: 保留Java/Kotlin/XML文件，跳过其他类型
4. **统计报告**: 显示审查文件数量和跳过文件数量
5. **开始审查**: 仅对筛选后的文件进行代码审查

##  输出文件功能实现

### 文件生成流程
1. **生成报告**: 按照标准模板生成完整的审查报告内容
2. **控制台输出**: 在控制台显示审查报告
3. **文件写入**: 将报告内容写入到指定的输出文件
4. **结果确认**: 显示文件保存成功的确认信息
5. **错误处理**: 如果保存失败，显示错误信息但不中断流程

### 输出确认格式
```
 审查报告已保存到: [文件路径]
```

